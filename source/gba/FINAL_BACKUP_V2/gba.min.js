/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/gbajs@1.1.2/js/gba.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var queueFrame,fs=require("fs"),PNG=require("pngjs").PNG,ARMCore=require("./core"),GameBoyAdvanceMMU=require("./mmu").GameBoyAdvanceMMU,GameBoyAdvanceInterruptHandler=require("./irq"),GameBoyAdvanceIO=require("./io"),GameBoyAdvanceAudio=require("./audio"),GameBoyAdvanceVideo=require("./video"),GameBoyAdvanceKeypad=require("./keypad"),GameBoyAdvanceSIO=require("./sio"),MemoryCanvas=require("./memory-canvas");function GameBoyAdvance(){this.LOG_ERROR=1,this.LOG_WARN=2,this.LOG_STUB=4,this.LOG_INFO=8,this.LOG_DEBUG=16,this.SYS_ID="com.endrift.gbajs",this.logLevel=this.LOG_ERROR|this.LOG_WARN,this.rom=null,this.cpu=new ARMCore,this.mmu=new GameBoyAdvanceMMU,this.irq=new GameBoyAdvanceInterruptHandler,this.io=new GameBoyAdvanceIO,this.audio=new GameBoyAdvanceAudio,this.video=new GameBoyAdvanceVideo,this.keypad=new GameBoyAdvanceKeypad,this.sio=new GameBoyAdvanceSIO,this.cpu.mmu=this.mmu,this.cpu.irq=this.irq,this.mmu.cpu=this.cpu,this.mmu.core=this,this.irq.cpu=this.cpu,this.irq.io=this.io,this.irq.audio=this.audio,this.irq.video=this.video,this.irq.core=this,this.io.cpu=this.cpu,this.io.audio=this.audio,this.io.video=this.video,this.io.keypad=this.keypad,this.io.sio=this.sio,this.io.core=this,this.audio.cpu=this.cpu,this.audio.core=this,this.video.cpu=this.cpu,this.video.core=this,this.keypad.core=this,this.sio.core=this,this.keypad.registerHandlers(),this.doStep=this.waitFrame,this.paused=!1,this.seenFrame=!1,this.seenSave=!1,this.lastVblank=0,this.queue=null,this.reportFPS=null,this.throttle=16;var e=this;queueFrame=function(t){e.queue=setTimeout(t,e.throttle)},this.video.vblankCallback=function(){e.seenFrame=!0}}GameBoyAdvance.MemoryCanvas=MemoryCanvas,GameBoyAdvance.prototype.setCanvas=function(e){var t=this;if(240!=e.offsetWidth||160!=e.offsetHeight){this.indirectCanvas=document.createElement("canvas"),this.indirectCanvas.setAttribute("height","160"),this.indirectCanvas.setAttribute("width","240"),this.targetCanvas=e,this.setCanvasDirect(this.indirectCanvas);var i=e.getContext("2d");this.video.drawCallback=function(){i.drawImage(t.indirectCanvas,0,0,e.offsetWidth,e.offsetHeight)}}else{this.setCanvasDirect(e);t=this}},GameBoyAdvance.prototype.setCanvasDirect=function(e){this.context=e.getContext("2d"),this.video.setBacking(this.context)},GameBoyAdvance.prototype.setCanvasMemory=function(){var e=new MemoryCanvas;this.setCanvasDirect(e)},GameBoyAdvance.prototype.setBios=function(e,t){this.mmu.loadBios(e,t)},GameBoyAdvance.prototype.setRom=function(e){return this.reset(),this.rom=this.mmu.loadRom(e,!0),!!this.rom&&(this.retrieveSavedata(),!0)},GameBoyAdvance.prototype.hasRom=function(){return!!this.rom},GameBoyAdvance.prototype.loadRomFromFile=function(e,t){var i=this;fs.readFile(e,(function(e,a){if(e)return this.ERROR(e),void(t&&t(e,!1));var o=i.setRom(a);t&&t(o?null:new Error("Invalid ROM"),o)}))},GameBoyAdvance.prototype.reset=function(){this.audio.pause(!0),this.mmu.clear(),this.io.clear(),this.audio.clear(),this.video.clear(),this.sio.clear(),this.mmu.mmap(this.mmu.REGION_IO,this.io),this.mmu.mmap(this.mmu.REGION_PALETTE_RAM,this.video.renderPath.palette),this.mmu.mmap(this.mmu.REGION_VRAM,this.video.renderPath.vram),this.mmu.mmap(this.mmu.REGION_OAM,this.video.renderPath.oam),this.cpu.resetCPU(0)},GameBoyAdvance.prototype.step=function(){for(;this.doStep();)this.cpu.step()},GameBoyAdvance.prototype.waitFrame=function(){var e=this.seenFrame;return this.seenFrame=!1,!e},GameBoyAdvance.prototype.pause=function(){this.paused=!0,this.audio.pause(!0),this.queue&&(clearTimeout(this.queue),this.queue=null)},GameBoyAdvance.prototype.advanceFrame=function(){this.step(),this.seenSave?this.mmu.saveNeedsFlush()?this.mmu.flushSave():(this.storeSavedata(),this.seenSave=!1):this.mmu.saveNeedsFlush()&&(this.seenSave=!0,this.mmu.flushSave())},GameBoyAdvance.prototype.runStable=function(){if(!this.interval){var e,t=this,i=0,a=0,o=Date.now();this.paused=!1,this.audio.pause(!1),e=this.reportFPS?function(){try{if(i+=Date.now()-o,t.paused)return;queueFrame(e),o=Date.now(),t.advanceFrame(),60==++a&&(t.reportFPS(1e3*a/i),a=0,i=0)}catch(e){throw t.ERROR(e),e.stack&&t.logStackTrace(e.stack.split("\n")),e}}:function(){try{if(t.paused)return;queueFrame(e),t.advanceFrame()}catch(e){throw t.ERROR(e),e.stack&&t.logStackTrace(e.stack.split("\n")),e}},queueFrame(e)}},GameBoyAdvance.prototype.setSavedata=function(e){this.mmu.loadSavedata(e)},GameBoyAdvance.prototype.loadSavedataFromFile=function(e,t){var i=this;fs.readFile(e,(function(e,a){e?i.ERROR(e):i.setSavedata(a),t&&t(e)}))},GameBoyAdvance.prototype.decodeSavedata=function(e){this.setSavedata(this.decodeBase64(e))},GameBoyAdvance.prototype.decodeBase64=function(e){var t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);for(var i=new ArrayBuffer(t),a=new Uint8Array(i),o=e.match(/..../g),s=0;s+2<t;s+=3){var r=atob(o.shift());a[s]=r.charCodeAt(0),a[s+1]=r.charCodeAt(1),a[s+2]=r.charCodeAt(2)}if(s<t){r=atob(o.shift());a[s++]=r.charCodeAt(0),r.length>1&&(a[s++]=r.charCodeAt(1))}return i},GameBoyAdvance.prototype.encodeBase64=function(e){for(var t,i,a=[],o=[],s=0;s<e.byteLength;++s)for(t=e.getUint8(s,!0),o.push(String.fromCharCode(t));o.length>=3;)i=o.splice(0,3),a.push(btoa(i.join("")));return o.length&&a.push(btoa(o.join(""))),a.join("")},GameBoyAdvance.prototype.downloadSavedataToFile=function(e,t){var i=this.mmu.save;if(!i)return this.WARN("No save data available"),null;var a=Buffer.from(i.buffer),o=this;fs.writeFile(e,a,(function(e){e&&o.ERROR(e),t&&t(e)}))},GameBoyAdvance.prototype.downloadSavedata=function(){var e=this.mmu.save;if(!e)return this.WARN("No save data available"),null;if(window.URL){var t=window.URL.createObjectURL(new Blob([e.buffer],{type:"application/octet-stream"}));window.open(t)}else{var i=this.encodeBase64(e.view);window.open("data:application/octet-stream;base64,"+i,this.rom.code+".sav")}},GameBoyAdvance.prototype.storeSavedata=function(){var e=this.mmu.save;try{window.localStorage[this.SYS_ID+"."+this.mmu.cart.code]=this.encodeBase64(e.view)}catch(e){this.WARN("Could not store savedata! "+e)}},GameBoyAdvance.prototype.retrieveSavedata=function(){try{var e=window.localStorage[this.SYS_ID+"."+this.mmu.cart.code];if(e)return this.decodeSavedata(e),!0}catch(e){this.WARN("Could not retrieve savedata! "+e)}return!1},GameBoyAdvance.prototype.screenshot=function(){var e=this.context.pixelData,t=new PNG({width:e.width,height:e.height,bitDepth:8,colorType:6,inputColorType:6,inputHasAlpha:!0});return t.data=e.data,t},GameBoyAdvance.prototype.freeze=function(){return{cpu:this.cpu.freeze(),mmu:this.mmu.freeze(),irq:this.irq.freeze(),io:this.io.freeze(),audio:this.audio.freeze(),video:this.video.freeze()}},GameBoyAdvance.prototype.defrost=function(e){this.cpu.defrost(e.cpu),this.mmu.defrost(e.mmu),this.audio.defrost(e.audio),this.video.defrost(e.video),this.irq.defrost(e.irq),this.io.defrost(e.io)},GameBoyAdvance.prototype.log=function(e,t){},GameBoyAdvance.prototype.setLogger=function(e){this.log=e},GameBoyAdvance.prototype.logStackTrace=function(e){var t=e.length-32;this.ERROR("Stack trace follows:"),t>0&&this.log(-1,"> (Too many frames)");for(var i=Math.max(t,0);i<e.length;++i)this.log(-1,"> "+e[i])},GameBoyAdvance.prototype.ERROR=function(e){this.logLevel&this.LOG_ERROR&&this.log(this.LOG_ERROR,e)},GameBoyAdvance.prototype.WARN=function(e){this.logLevel&this.LOG_WARN&&this.log(this.LOG_WARN,e)},GameBoyAdvance.prototype.STUB=function(e){this.logLevel&this.LOG_STUB&&this.log(this.LOG_STUB,e)},GameBoyAdvance.prototype.INFO=function(e){this.logLevel&this.LOG_INFO&&this.log(this.LOG_INFO,e)},GameBoyAdvance.prototype.DEBUG=function(e){this.logLevel&this.LOG_DEBUG&&this.log(this.LOG_DEBUG,e)},GameBoyAdvance.prototype.ASSERT_UNREACHED=function(e){throw new Error("Should be unreached: "+e)},GameBoyAdvance.prototype.ASSERT=function(e,t){if(!e)throw new Error("Assertion failed: "+t)},module.exports=GameBoyAdvance;
//# sourceMappingURL=/sm/13ec925ef9aa3300c5bb159dcb02dcd0346779bb2445108170c6fbebd619781a.map